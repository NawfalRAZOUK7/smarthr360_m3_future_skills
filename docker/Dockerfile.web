
# syntax=docker/dockerfile:1.4

# --- Builder stage: build assets and collect static files ---
FROM smarthr360-base-local as builder

WORKDIR /app

# Copy app code and config for build
COPY manage.py pyproject.toml pytest.ini ./
COPY config/ ./config/
COPY future_skills/ ./future_skills/

# Copy celery_monitoring for monitoring and metrics
COPY celery_monitoring/ ./celery_monitoring/

# Ensure staticfiles directory exists in builder
RUN mkdir -p /app/staticfiles

# (Optional) Install Node and npm/yarn if frontend assets exist
# RUN apt-get update && apt-get install -y nodejs npm
# COPY frontend/ ./frontend/
# RUN cd frontend && npm install && npm run build


# --- Final stage: minimal runtime image ---
FROM smarthr360-base-local as final

WORKDIR /app

# Copy only runtime code and built static files from builder
COPY --from=builder /app/manage.py ./
COPY --from=builder /app/pyproject.toml ./
# (pytest.ini omitted from runtime image)
COPY --from=builder /app/config/ ./config/
COPY --from=builder /app/future_skills/ ./future_skills/
COPY --from=builder /app/staticfiles/ ./staticfiles/

# Copy celery_monitoring for monitoring and metrics
COPY --from=builder /app/celery_monitoring/ ./celery_monitoring/


# Make generate-secrets.sh executable and run it during build
# COPY scripts/generate-secrets.sh /app/generate-secrets.sh
# RUN chmod +x /app/generate-secrets.sh && /app/generate-secrets.sh

EXPOSE 8000

# Copy entrypoint script
COPY scripts/entrypoints/web-entrypoint.sh /app/web-entrypoint.sh
RUN chmod +x /app/web-entrypoint.sh

ENTRYPOINT ["/app/web-entrypoint.sh"]
