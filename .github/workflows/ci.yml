name: CI Pipeline

on:
  push:
    branches: [main, staging, feature/**]
  pull_request:
    branches: [main, staging]

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "18"
  DOCKER_BUILDKIT: 1

jobs:
  # Code Quality Checks
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run code quality checks
        run: |
          make lint
          make format-check
          make type-check

      - name: Security scan
        run: |
          make security-scan
          safety check --output text || true
          bandit -r future_skills/ -f json -o security-report.json || true

      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.json

  # Unit Tests
  test-unit:
    runs-on: ubuntu-latest
    needs: quality
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: pip install -r requirements-dev.txt

      - name: Run database migrations
        run: |
          python manage.py migrate
        env:
          DJANGO_SETTINGS_MODULE: config.settings.test
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379/0

      - name: Run unit tests
        run: |
          pytest future_skills/tests/ -v --cov=future_skills --cov-report=xml --cov-report=term-missing --cov-fail-under=80
        env:
          DJANGO_SETTINGS_MODULE: config.settings.test
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379/0

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unit-tests
          name: unit-tests-coverage

  # ML Tests
  test-ml:
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install -r requirements-dev.txt
          pip install -r ml/requirements.txt

      - name: Run ML tests
        run: |
          pytest ml/tests/ -v --cov=ml --cov-report=xml --cov-report=term-missing --cov-fail-under=60 -m "not slow"
        env:
          DJANGO_SETTINGS_MODULE: config.settings.test

      - name: Upload ML coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: ml-tests
          name: ml-tests-coverage

  # Integration Tests
  test-integration:
    runs-on: ubuntu-latest
    needs: [test-unit, test-ml]
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: pip install -r requirements-dev.txt

      - name: Run integration tests
        run: |
          pytest tests/integration/ -v --cov=future_skills --cov-report=xml --cov-report=term-missing --cov-fail-under=70
        env:
          DJANGO_SETTINGS_MODULE: config.settings.test
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379/0

      - name: Upload integration coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: integration-tests
          name: integration-tests-coverage

  # Docker Build Test
  docker-test:
    runs-on: ubuntu-latest
    needs: [test-unit, test-ml, test-integration]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build test images
        run: |
          docker build -f Dockerfile.base -t smarthr360/base:test .
          docker build -f Dockerfile.web -t smarthr360/web:test .
          docker build -f Dockerfile.celery -t smarthr360/celery:test .
          docker build -f Dockerfile.nginx -t smarthr360/nginx:test .

      - name: Test Docker images
        run: |
          # Test web container
          docker run --rm smarthr360/web:test python manage.py check --deploy
          # Test celery container
          docker run --rm smarthr360/celery:test celery -A config worker --help | head -5

  # Performance Tests
  performance:
    runs-on: ubuntu-latest
    needs: docker-test
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Run performance tests
        run: |
          make test-performance
        env:
          DJANGO_SETTINGS_MODULE: config.settings.test

  # Final status check
  ci-success:
    runs-on: ubuntu-latest
    needs: [quality, test-unit, test-ml, test-integration, docker-test]
    if: success()
    steps:
      - name: CI Pipeline Success
        run: echo "âœ… All CI checks passed successfully!"
