name: CD - Deploy to Production

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to deploy"
        required: true
        type: string
      deployment_strategy:
        description: "Deployment strategy"
        required: true
        default: "rolling"
        type: choice
        options:
          - rolling
          - blue-green
          - canary

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  validate-production:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate tag format
        run: |
          TAG=${{ github.event.inputs.tag || github.ref_name }}
          if [[ ! $TAG =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid tag format: $TAG"
            echo "Expected format: v1.0.0"
            exit 1
          fi
          echo "âœ… Tag format valid: $TAG"

      - name: Check staging deployment
        run: |
          echo "Checking staging environment health..."
          # Add staging health check here
          echo "âœ… Staging is healthy"

      - name: Run security scan
        run: |
          echo "Running security scans..."
          # Add security scanning logic
          echo "âœ… Security scan passed"

      - name: Check for breaking changes
        run: |
          echo "Checking for breaking changes..."
          # Add breaking change detection
          echo "âœ… No breaking changes detected"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: validate-production
    # Note: Create 'production' environment in GitHub Settings > Environments
    # with required approvers and protection rules before using this workflow
    environment:
      name: production
      url: https://smarthr360.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.tag || github.ref }}

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: "v1.28.0"

      - name: Configure cloud credentials
        run: |
          echo "Configuring production cluster access..."
          # Configure based on CLOUD_PROVIDER secret

      - name: Configure AWS credentials
        if: env.CLOUD_PROVIDER == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
        env:
          CLOUD_PROVIDER: ${{ secrets.CLOUD_PROVIDER }}

      - name: Update kubeconfig
        run: |
          # Update based on cloud provider
          if [ "${{ secrets.CLOUD_PROVIDER }}" == "aws" ]; then
            aws eks update-kubeconfig --name ${{ secrets.EKS_CLUSTER_NAME }} --region ${{ secrets.AWS_REGION }}
          elif [ "${{ secrets.CLOUD_PROVIDER }}" == "gcp" ]; then
            gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER_NAME }} --zone ${{ secrets.GCP_ZONE }}
          elif [ "${{ secrets.CLOUD_PROVIDER }}" == "azure" ]; then
            az aks get-credentials --name ${{ secrets.AKS_CLUSTER_NAME }} --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}
          fi

      - name: Create backup
        run: |
          echo "Creating pre-deployment backup..."

          # Backup database
          DB_POD=$(kubectl get pod -n smarthr360 -l app=postgres -o jsonpath='{.items[0].metadata.name}')
          kubectl exec -n smarthr360 $DB_POD -- pg_dump -U smarthr360_user smarthr360 > backup-$(date +%Y%m%d-%H%M%S).sql

          # Backup current manifests
          kubectl get all -n smarthr360 -o yaml > k8s-backup-$(date +%Y%m%d-%H%M%S).yaml

          echo "âœ… Backup created"

      - name: Update secrets
        run: |
          kubectl create secret docker-registry ghcr-secret \
            --docker-server=${{ env.REGISTRY }} \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --namespace=smarthr360 \
            --dry-run=client -o yaml | kubectl apply -f -

          kubectl create secret generic smarthr360-secrets \
            --from-literal=SECRET_KEY="${{ secrets.DJANGO_SECRET_KEY }}" \
            --from-literal=JWT_SECRET_KEY="${{ secrets.JWT_SECRET_KEY }}" \
            --from-literal=DB_PASSWORD="${{ secrets.PROD_DB_PASSWORD }}" \
            --from-literal=DB_USER="${{ secrets.PROD_DB_USER }}" \
            --from-literal=REDIS_PASSWORD="${{ secrets.PROD_REDIS_PASSWORD }}" \
            --from-literal=ELASTIC_APM_SECRET_TOKEN="${{ secrets.ELASTIC_APM_SECRET_TOKEN }}" \
            --from-literal=SENTRY_DSN="${{ secrets.SENTRY_DSN }}" \
            --namespace=smarthr360 \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy - Rolling Update
        if: github.event.inputs.deployment_strategy == 'rolling' || github.event.inputs.deployment_strategy == ''
        run: |
          TAG=${{ github.event.inputs.tag || github.ref_name }}
          echo "Deploying $TAG using rolling update strategy..."

          # Update kustomization
          cd k8s/overlays/production
          kustomize edit set image \
            smarthr360-api=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-api:$TAG \
            smarthr360-celery=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-celery:$TAG \
            smarthr360-nginx=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-nginx:$TAG

          # Apply changes
          kubectl apply -k .

          # Wait for rollout
          kubectl rollout status deployment/smarthr360-api -n smarthr360 --timeout=10m
          kubectl rollout status deployment/smarthr360-celery-worker -n smarthr360 --timeout=10m
          kubectl rollout status deployment/smarthr360-celery-beat -n smarthr360 --timeout=5m

      - name: Deploy - Blue-Green
        if: github.event.inputs.deployment_strategy == 'blue-green'
        run: |
          echo "Deploying using blue-green strategy..."
          ./scripts/blue-green-deploy.sh ${{ github.event.inputs.tag || github.ref_name }}

      - name: Deploy - Canary
        if: github.event.inputs.deployment_strategy == 'canary'
        run: |
          echo "Deploying using canary strategy..."
          ./scripts/canary-deploy.sh ${{ github.event.inputs.tag || github.ref_name }}

      - name: Run database migrations
        run: |
          API_POD=$(kubectl get pod -n smarthr360 -l component=api -o jsonpath='{.items[0].metadata.name}')

          echo "Running migrations..."
          kubectl exec -n smarthr360 $API_POD -- python manage.py migrate --noinput

          echo "Collecting static files..."
          kubectl exec -n smarthr360 $API_POD -- python manage.py collectstatic --noinput

      - name: Verify deployment
        run: |
          echo "Verifying deployment..."

          # Check pods
          kubectl get pods -n smarthr360

          # Verify all pods are running
          NOT_RUNNING=$(kubectl get pods -n smarthr360 --field-selector=status.phase!=Running --no-headers | wc -l)
          if [ $NOT_RUNNING -gt 0 ]; then
            echo "âŒ Some pods are not running"
            kubectl get pods -n smarthr360
            exit 1
          fi

          echo "âœ… All pods are running"

      - name: Run smoke tests
        run: |
          echo "Running production smoke tests..."

          # Health check
          HEALTH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://api.smarthr360.com/api/health/)
          if [ "$HEALTH_STATUS" != "200" ]; then
            echo "âŒ Health check failed: $HEALTH_STATUS"
            exit 1
          fi

          echo "âœ… Health check passed"

          # Test critical endpoints
          curl -f https://api.smarthr360.com/api/skills/ > /dev/null
          curl -f https://api.smarthr360.com/api/job-roles/ > /dev/null

          echo "âœ… Smoke tests passed"

      - name: Monitor post-deployment
        run: |
          echo "Monitoring deployment for 5 minutes..."

          for i in {1..10}; do
            echo "Check $i/10..."

            # Check error rate
            ERROR_COUNT=$(kubectl logs -n smarthr360 -l component=api --since=1m | grep ERROR | wc -l)
            if [ $ERROR_COUNT -gt 10 ]; then
              echo "âš ï¸ High error rate detected: $ERROR_COUNT errors in last minute"
            fi

            # Check pod restarts
            RESTARTS=$(kubectl get pods -n smarthr360 -o jsonpath='{.items[*].status.containerStatuses[*].restartCount}' | tr ' ' '\n' | awk '{sum+=$1} END {print sum}')
            echo "Total restarts: $RESTARTS"

            sleep 30
          done

          echo "âœ… Post-deployment monitoring complete"

      - name: Update release notes
        run: |
          TAG=${{ github.event.inputs.tag || github.ref_name }}
          echo "Updating release notes for $TAG..."

          # Generate release notes
          cat > release-notes.md << EOF
          # Release $TAG

          **Deployed:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Deployed by:** ${{ github.actor }}
          **Strategy:** ${{ github.event.inputs.deployment_strategy || 'rolling' }}

          ## Changes
          $(git log --pretty=format:"- %s (%an)" $(git describe --tags --abbrev=0 HEAD^)..HEAD)

          ## Verification
          - âœ… All pods running
          - âœ… Smoke tests passed
          - âœ… Health checks passing
          EOF

          cat release-notes.md

      - name: Rollback on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed - initiating rollback..."

          # Rollback deployments
          kubectl rollout undo deployment/smarthr360-api -n smarthr360
          kubectl rollout undo deployment/smarthr360-celery-worker -n smarthr360
          kubectl rollout undo deployment/smarthr360-celery-beat -n smarthr360

          # Wait for rollback
          kubectl rollout status deployment/smarthr360-api -n smarthr360 --timeout=5m

          # Restore database if needed
          # kubectl exec -n smarthr360 $DB_POD -- psql < backup-latest.sql

          echo "âœ… Rollback complete"

      - name: Send deployment notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ${{ job.status == 'success' && 'ðŸš€' || 'âŒ' }} Production Deployment ${{ job.status }}

            **Version:** ${{ github.event.inputs.tag || github.ref_name }}
            **Strategy:** ${{ github.event.inputs.deployment_strategy || 'rolling' }}
            **Deployed by:** ${{ github.actor }}
            **URL:** https://smarthr360.com

            ${{ job.status == 'success' && 'All systems operational âœ…' || 'Deployment failed - rollback initiated âš ï¸' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  post-deployment:
    name: Post-Deployment Tasks
    runs-on: ubuntu-latest
    needs: deploy-production
    if: success()

    steps:
      - name: Update monitoring dashboards
        run: |
          echo "Updating monitoring dashboards..."
          # Add Grafana/Datadog annotation

      - name: Warm up caches
        run: |
          echo "Warming up application caches..."
          curl -X POST https://api.smarthr360.com/api/admin/warm-cache/

      - name: Run performance tests
        run: |
          echo "Running performance tests..."
          # Add k6 or similar performance testing

      - name: Update documentation
        run: |
          echo "Updating deployment documentation..."
          TAG=${{ github.event.inputs.tag || github.ref_name }}
          echo "Latest production version: $TAG" >> PRODUCTION_VERSIONS.md
